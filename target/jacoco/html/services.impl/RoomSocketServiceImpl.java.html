<?xml version="1.0" encoding="utf-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>RoomSocketServiceImpl.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=2;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Jacoco Coverage Report</a> &gt; <a href="index.source.html" class="el_package">services.impl</a> &gt; <span class="el_source">RoomSocketServiceImpl.java</span></div><h1>RoomSocketServiceImpl.java</h1><pre class="source lang-java linenums">package services.impl;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.node.ObjectNode;
import com.google.inject.Inject;
import models.AbstractRoom;
import models.PublicRoom;
import models.User;
import play.db.jpa.JPA;
import play.libs.F;
import play.libs.Json;
import play.mvc.WebSocket;
import redis.clients.jedis.Jedis;
import scala.concurrent.Await;
import scala.concurrent.duration.Duration;
import services.*;
import sockets.RoomSocket;

import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

import static akka.pattern.Patterns.ask;
import static java.util.concurrent.TimeUnit.SECONDS;
import static play.libs.Json.toJson;

/**
 * Created by kdoherty on 7/13/15.
 */
public class RoomSocketServiceImpl implements RoomSocketService {

    private final AbstractRoomService abstractRoomService;
    private final PublicRoomService publicRoomService;
    private final JedisService jedisService;
    private final UserService userService;

    @Inject
<span class="fc" id="L38">    public RoomSocketServiceImpl(AbstractRoomService abstractRoomService, PublicRoomService publicRoomService, UserService userService, JedisService jedisService) {</span>
<span class="fc" id="L39">        this.abstractRoomService = abstractRoomService;</span>
<span class="fc" id="L40">        this.publicRoomService = publicRoomService;</span>
<span class="fc" id="L41">        this.userService = userService;</span>
<span class="fc" id="L42">        this.jedisService = jedisService;</span>
<span class="fc" id="L43">    }</span>

    @Override
    public void join(long roomId, long userId, WebSocket.In&lt;JsonNode&gt; in, WebSocket.Out&lt;JsonNode&gt; out) throws Exception {
<span class="fc" id="L47">        String result = (String) Await.result(ask(RoomSocket.defaultRoom, new RoomSocket.Join(roomId, userId, out), 3000), Duration.create(3, SECONDS));</span>

<span class="pc bpc" id="L49" title="1 of 2 branches missed.">        if (RoomSocket.OK_JOIN_RESULT.equals(result)) {</span>

<span class="fc" id="L51">            jedisService.useJedisResource(jedis -&gt; {</span>
                ObjectNode joinSuccessEvent = getSuccessfulJoinEvent(roomId, userId, jedis);
                out.write(joinSuccessEvent);
                in.onMessage(new SocketMessageReceiver(roomId, userId, jedis));
            });

            // When the socket is closed.
<span class="fc" id="L58">            in.onClose(() -&gt; RoomSocket.defaultRoom.tell(new RoomSocket.Quit(roomId, userId), null));</span>

        } else {
<span class="nc" id="L61">            ObjectNode error = getFailedJoinEvent(result);</span>
            // Send the error to socket of the user who is trying to connect.
<span class="nc" id="L63">            out.write(error);</span>
        }
<span class="fc" id="L65">    }</span>

    private ObjectNode getSuccessfulJoinEvent(long roomId, long userId, Jedis jedis) {

<span class="fc" id="L69">        ObjectNode event = Json.newObject();</span>
<span class="fc" id="L70">        event.put(RoomSocket.EVENT_KEY, &quot;joinSuccess&quot;);</span>

<span class="fc" id="L72">        JPA.withTransaction(() -&gt; {</span>
            // All room members not including the user themselves
            List&lt;User&gt; roomMembers = RoomSocket.getUserIdsInRoomStream(roomId, jedis)
                    .filter(id -&gt; id != KeepAliveService.ID &amp;&amp; id != userId)
                    .map(userService::findById)
                    .map(Optional::get)
                    .collect(Collectors.&lt;User&gt;toList());

            ObjectNode message = Json.newObject();
            message.set(&quot;roomMembers&quot;, toJson(roomMembers));

            Optional&lt;AbstractRoom&gt; roomOptional = abstractRoomService.findById(roomId);
            AbstractRoom room = roomOptional.orElseThrow(RuntimeException::new);

            if (room instanceof PublicRoom) {
                boolean isSubscribed = publicRoomService.isSubscribed((PublicRoom) room, userId);
                message.put(&quot;isSubscribed&quot;, isSubscribed);
            }

            event.set(RoomSocket.MESSAGE_KEY, message);
        });

<span class="fc" id="L94">        return event;</span>
    }

    private ObjectNode getFailedJoinEvent(String result) {
<span class="nc" id="L98">        return Json.newObject()</span>
<span class="nc" id="L99">                .put(RoomSocket.EVENT_KEY, &quot;error&quot;)</span>
<span class="nc" id="L100">                .put(RoomSocket.MESSAGE_KEY, result);</span>
    }


    private class SocketMessageReceiver implements F.Callback&lt;JsonNode&gt; {

        private long roomId;
        private long userId;
        private Jedis jedis;

<span class="fc" id="L110">        private SocketMessageReceiver(long roomId, long userId, Jedis jedis) {</span>
<span class="fc" id="L111">            this.roomId = roomId;</span>
<span class="fc" id="L112">            this.userId = userId;</span>
<span class="fc" id="L113">            this.jedis = jedis;</span>
<span class="fc" id="L114">        }</span>

        @Override
        public void invoke(JsonNode message) throws Throwable {
<span class="fc" id="L118">            final String event = message.get(&quot;event&quot;).asText();</span>

            Object messageObject;
<span class="pc bpc" id="L121" title="4 of 10 branches missed.">            switch (event) {</span>
                case RoomSocket.Talk.TYPE:
<span class="pc bpc" id="L123" title="1 of 4 branches missed.">                    if (message.has(&quot;isAnon&quot;) &amp;&amp; message.get(&quot;isAnon&quot;).asBoolean()) {</span>
<span class="fc" id="L124">                        messageObject = new RoomSocket.Talk(roomId, userId, message.get(&quot;message&quot;).asText(), true);</span>
                    } else {
<span class="fc" id="L126">                        messageObject = new RoomSocket.Talk(roomId, userId, message.get(&quot;message&quot;).asText());</span>
                    }
<span class="fc" id="L128">                    break;</span>
                case RoomSocket.FavoriteNotification.TYPE:
<span class="fc" id="L130">                    messageObject = new RoomSocket.FavoriteNotification(userId, Long.parseLong(message.get(&quot;messageId&quot;).asText()), message.get(&quot;action&quot;).asText());</span>
<span class="fc" id="L131">                    break;</span>
                default:
<span class="nc" id="L133">                    throw new RuntimeException(&quot;Event: &quot; + event + &quot; is not supported&quot;);</span>
            }

<span class="fc" id="L136">            jedis.publish(RoomSocket.CHANNEL, Json.stringify(toJson(messageObject)));</span>
<span class="fc" id="L137">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.1.201405082137</span></div></body></html>